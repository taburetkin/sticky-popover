const t={top:"bottom",left:"right"},e={top:"height",bottom:"height",left:"width",right:"width"},i={width:{dimension:"width",opposite:"height",start:"left",end:"right"},height:{dimension:"height",opposite:"width",start:"top",end:"bottom"}};function o(t,o){const n=e[t],s=i[n],r=s.opposite,l=i[r];return{id:t,opposite:o,dimension:n,dimensionStart:s.start,dimensionEnd:s.end,altDimension:r,altStart:l.start,altEnd:l.end,main:{...s},alt:{...l}}}const n=Object.keys(t).reduce(((e,i)=>{const n=t[i];return e[i]=o(i,n),e[n]=o(n,i),e}),{}),s={start:1,center:1,end:1},r=t=>t<0?0:t,l=(t,e,i,o,s=n[i].opposite)=>o(t[i],e[i])?e[i]:o(t[i],e[s])?t[i]:e[s],h=(t,e,i)=>l(t,e,i,((t,e)=>t<e)),d=(t,e,i)=>l(t,e,i,((t,e)=>t>e));function a(t){return t.visibleHeight=r(t.bottom-t.top),t.visibleWidth=r(t.right-t.left),t.isVisible=t.visibleHeight>0&&t.visibleWidth>0,t}function c(t,e){let i=e.offsetMain||0;return t.id===t.dimensionStart?-i:i}function p(t,e,i,o){const n=t[i.id],s=e[i.dimension];return(i.id===i.dimensionStart?n-s:n)+c(i,o)}function u(t,e,i,o,n){const s=t[i.altStart],r=t[i.altEnd],l=e[i.altDimension],h=function(t,e){const i=t.offsetAlt||0;return"center"===e||0===i?0:"start"===e?i:-i}(n,o);switch(o){case"start":return s+h;case"end":return r-l+h}return(s+r)/2-l/2}function g(t,e,i,o,n){const s=i[t.alt.start],r=(i[t.alt.start]+i[t.alt.end])/2,l={start:o-s>n,center:r>n/2&&o-r>n/2,end:i[t.alt.end]>n};if(l[e])return e;if("center"===e)return l.start?"start":l.end?"end":e;if(l.center)return"center";const h="start"===e?"end":"start";return l[h]?h:e}function m(t,e,i,o){return{[(t=(t=>"string"==typeof t?n[t]:t)(t)).alt.dimension]:i[t.alt.dimension],[t.main.dimension]:t.id===t.main.start?e[t.id]-o:i[t.dimension]-e[t.id]-o}}const v={getBoundingBox(t,e){const i=t.getBoundingClientRect();if(!e)return i;const{left:o,top:n,right:s,bottom:r,width:l,height:h}=i;return{left:o,top:n,right:s,bottom:r,width:l,height:h}},getVisibleBox(t,e){if(e=e||this.getViewport(),!t||t===document.body)return e;let i=t,o=[];for(;null!=i;)o.push(i),i=i.parentNode!==document.body?i.parentNode:null;let{left:n,top:s,right:r,bottom:l}=e;const c={left:n,top:s,right:r,bottom:l};for(;o.length;){let t=o.pop();const e=this.getBoundingBox(t);c.width=e.width,c.height=e.height,n=h(e,c,"left"),s=h(e,c,"top"),r=d(e,c,"right"),l=d(e,c,"bottom"),c.left=n,c.top=s,c.right=r,c.bottom=l}return a(c)},getViewport(){let t=window.innerWidth,e=window.innerHeight;const i={left:0,top:0,right:t,bottom:e,width:t,height:e},o=window.visualViewport;return o&&(i.width=o.width,i.height=o.height),a(i)},findPosition(t,e,i,o,s,r){let l=n[i],h=o;if(!1!==s.autoPlacement){let i=this.detectAvailableSide(t,e,l,o,r,s);l=i.side,h=i.align}return{position:this.getSidePosition(t,e,l,h,s),side:l.id,align:h}},detectAvailableSide(t,e,i,o,s,r){"string"==typeof i&&(i=n[i]);let l=i,h=o;const d=c(i,r),a=[i.id,i.altEnd,i.altStart,i.opposite];for(let i of a){const r=m(i,t,s,d);if(r.width>=e.width&&r.height>=e.height){l=n[i];const s=e[l.altDimension];h=g(l,o,t,r[l.altDimension],s);break}}return{side:l,align:h}},getSidePosition:(t,e,i,o,n)=>({[i.dimensionStart]:p(t,e,i,n),[i.altStart]:u(t,e,i,o,n),[i.dimensionEnd]:void 0,[i.altEnd]:void 0})};function f(t="",e,i){const o=t.split("-");let r=o[0],l=o[1];return r&&!l&&(l="center"),r in n==!1&&(r=e),l in s==!1&&(l=i),{side:r,align:l}}function w(t,e){Object.assign(t.style,e)}const b={top:0,left:0,right:"unset",bottom:"unset"};class S{constructor(t){this.scrollListeners=[],this.setOptions(t),t&&(this.refEl=t.referenceEl)}setOptions(t){this.options=E(t,{defaultSide:"bottom",defaultAlign:"start"})}setReferenceElement(t,e){this._removeScrollListeners(),this._setScrollListeners(t,e),this.refEl=t}_removeScrollListeners(){this.scrollListeners.forEach((({event:t,callback:e,el:i})=>{i.removeEventListener(t,e)})),this.scrollListeners.length=0}_setScrollListeners(t,e){let i=t.parentNode;const o=()=>this.update(e),n="scroll";for(;null!=i;)i.addEventListener(n,o),this.scrollListeners.push({el:i,event:n,callback:o}),i=i.parentNode}setPopoverElement(t){this.el=t,this.elBoundingBox=v.getBoundingBox(t)}_attachPopoverElement(t){null==t.parentNode&&document.body.appendChild(t)}_detachPopoverElement(t){t&&t.parentNode&&t.parentNode.removeChild(t)}show(t={}){this._isShowing&&this.hide(),this._isShowing=!0;let{referenceEl:e,popoverEl:i}=t;i=i||this.el,this._attachPopoverElement(i),this.setPopoverElement(i),t=Object.assign({},this.options,E(t,{defaultSide:this.options.side,defaultAlign:this.options.align})),e=e||this.refEl,this.setReferenceElement(e,t),this.update(t)}hide(){this._detachPopoverElement(this.el),this._removeScrollListeners(),this._isShowing=!1}update(t){const e=v.getViewport(),i=v.getVisibleBox(this.refEl,e);let o={display:"none"};if(i.isVisible){t=this.getUpdateOptions(Object.assign({referenceVisibleBox:i,viewport:e},this.options,t)),o.display=t.useElementDisplay||"block";const{position:n,side:s,align:r}=this.findElementPosition(t),l=function(t){return Object.keys(t).reduce(((e,i)=>{let o=t[i];return null==o?o="unset":o+="px",e[i]=o,e}),{})}(n);Object.assign(o,l),this.updateElementSideInfo(s,r)}o=this.getUpdateElementStyles(o),w(this.el,o)}getUpdateOptions(t){return t}getUpdateElementStyles(t){return t}updateElementSideInfo(t,e){this.el.setAttribute("data-side",t),this.el.setAttribute("data-align",e)}findElementPosition(t={}){let e=y("side",t,this.options),i=y("align",t,this.options),o=t.viewport||v.getViewport(),n=t.referenceVisibleBox||v.getVisibleBox(this.refEl,o);w(this.el,b);let s=this.elBoundingBox;return v.findPosition(n,s,e,i,t,o)}destroy(){this._isDestroying||this._isDestroyed||(this._isDestroying=!0,this.hide(),delete this.el,delete this.refEl,this._isDestroyed=!0)}isDestroyed(){return!0===this._isDestroyed}}function E(t,{normalizePlacement:e=!0,defaultSide:i,defaultAlign:o,leaveElements:n}={}){if(null==t||"string"==typeof t)return e?f(t,i,o):{};if(!(t=Object.assign({},t)).side&&!t.align&&e){const e=f(t.placement,i,o);t.side=e.side,t.align=e.align,delete t.placement}return n||(delete t.referenceEl,delete t.popoverEl),t}function y(t,e,i){return t in e?e[t]:i[t]}function P(t="not implemented",e){const i=new Error(t);throw console.warn(e),i}const _={items:new Map,getKey:t=>t.singleton||"default",get(t){const e=this.getKey(t);return this.items.get(e)},remove(t){const e=this.getKey(t);this.items.delete(e)},create(t,e){const i=this.getKey(t),o={key:i,popoverContext:t,remove:e};this.items.set(i,o)}};class x{initializePopover(t){this.setupPopoverShow(t,(e=>this._open(t,e)))}setupPopoverShow(t,e){P("setupPopoverShowTrigger not implemented","setupPopoverShow should implement settling event listeners to schedule popover show\n\t\tsetupPopoverShow(options, callback) {\n\t\t\t// information about reference element should be provided by you in config\n\t\t\toptions.referenceEl.addEventListener('mouseenter', callback);\n\t\t}")}getPopoverContext(t){P("getPopoverContext not implemented","getPopoverContext should return your popoverContext\n\t\tgetPopoverContext(options) {\n\t\t\t// popoverContext should have show method.\n\n\t\t\treturn {\n\t\t\t\tshow() {\n\t\t\t\t\t// ...\n\t\t\t\t},\n\t\t\t\tremove() {\n\t\t\t\t\t// ...\n\t\t\t\t}\n\t\t\t}\n\n\t\t}\n\t\t")}_open(t,e){const i=this.getPopoverContext(t);this.cancelRemoving(i),!0!==i.showing?i.showTimer||this.scheduleShow(i,t):!0===i.toggleStrategy&&this._removePopover(i)}_ensureSingleton(t){_.create(t,(()=>{_.remove(t),this._removePopover(t),this._tryRemoveShowedSingleton(t,!1)}))}_tryRemoveShowedSingleton(t,e){const i=_.get(t);if(!i)return;const o=i.popoverContext;o&&o.showing&&t===o===e&&i.remove()}_removePopover(t){this.cancelRemoving(t),this.cancelShowing(t),t.remove(),t.showing=!1}scheduleRemove(t){let e=t.removeDelay;null==e&&(e=500),this.cancelShowing(t),t.showing&&(this.cancelRemoving(t),t.removeTimeout=setTimeout((()=>this._removePopover(t)),e))}scheduleShow(t,e){let i=t.showDelay;null==i&&(i=500),t.showTimeout=setTimeout((()=>{this._tryRemoveShowedSingleton(t,!1),this._ensureSingleton(t),t.show(e),t.showing=!0}),i)}cancelRemoving(t){t.removeTimeout&&(clearTimeout(t.removeTimeout),delete t.removeTimeout)}cancelShowing(t){t.showTimeout&&(clearTimeout(t.showTimeout),delete t.showTimeout)}}class B extends x{constructor(){super(),this._popoverInstances=new Map}getPopoverInstance(t){const e=t.singleton||"default";let i=this._popoverInstances.get(e);return i||(i=new S,this._popoverInstances.set(e,i)),i}createPopoverContext(t,e,i={}){const o=this.getPopoverInstance(t);return{show(){const t=e(this);o.show(t)},remove(){o.hide()},...i}}}export{x as AbstractPopoverApi,S as Popover,B as PopoverApi,v as positioningApi};
